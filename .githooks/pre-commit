#!/usr/bin/env bash
# Pre-commit hook for markdown linting and auto-fixing

echo "Running markdown linter..."

# Check if markdownlint-cli2 is available
if ! command -v markdownlint-cli2 &> /dev/null; then
    echo "Warning: markdownlint-cli2 not found. Skipping markdown linting."
    echo "Install with: npm install -g markdownlint-cli2"
    exit 0
fi

# Get list of staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$')

if [ -z "$STAGED_MD_FILES" ]; then
    exit 0
fi

echo "Checking markdown files: $STAGED_MD_FILES"

# Run markdownlint-cli2 with auto-fix
markdownlint-cli2 --fix $STAGED_MD_FILES

# Check if files were modified
MODIFIED=false
for FILE in $STAGED_MD_FILES; do
    if ! git diff --quiet "$FILE"; then
        MODIFIED=true
        echo "Fixed: $FILE"
        git add "$FILE"
    fi
done

if [ "$MODIFIED" = true ]; then
    echo "Markdown files were auto-fixed and re-staged."
fi

# Run final check
if ! markdownlint-cli2 $STAGED_MD_FILES; then
    echo "Markdown linting failed. Please fix the issues and try again."
    exit 1
fi

echo "Markdown linting passed!"
exit 0